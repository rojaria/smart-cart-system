<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¬ê³  í…ŒìŠ¤íŠ¸</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .product { border: 1px solid #ccc; padding: 10px; margin: 10px 0; }
        .in-stock { color: green; }
        .out-of-stock { color: red; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>ì¬ê³  í…ŒìŠ¤íŠ¸ í˜ì´ì§€</h1>
    
    <div>
        <h2>ìƒí’ˆ ì¬ê³  í™•ì¸</h2>
        <button onclick="checkAllProducts()">ëª¨ë“  ìƒí’ˆ ì¬ê³  í™•ì¸</button>
        <button onclick="clearLog()">ë¡œê·¸ ì§€ìš°ê¸°</button>
    </div>
    
    <div id="products"></div>
    
    <div>
        <h2>ì¬ê³  ì°¨ê° í…ŒìŠ¤íŠ¸</h2>
        <input type="text" id="barcodeInput" placeholder="ë°”ì½”ë“œ ì…ë ¥" />
        <input type="number" id="quantityInput" placeholder="ìˆ˜ëŸ‰" value="1" min="1" />
        <button onclick="testStockReduction()">ì¬ê³  ì°¨ê° í…ŒìŠ¤íŠ¸</button>
    </div>
    
    <div class="log" id="log"></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, get, update, onValue } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyDqJqJqJqJqJqJqJqJqJqJqJqJqJqJqJq",
            authDomain: "smart-cart-476304.firebaseapp.com",
            databaseURL: "https://smart-cart-476304-default-rtdb.asia-southeast1.firebasedb.app",
            projectId: "smart-cart-476304",
            storageBucket: "smart-cart-476304.appspot.com",
            messagingSenderId: "1060519036613",
            appId: "1:1060519036613:web:abc123def456"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);

        // ìµëª… ë¡œê·¸ì¸
        signInAnonymously(auth).then(() => {
            addLog('âœ… Firebase ì¸ì¦ ì™„ë£Œ');
        }).catch(error => {
            addLog('âŒ Firebase ì¸ì¦ ì‹¤íŒ¨: ' + error.message);
        });

        function addLog(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
        }

        // ëª¨ë“  ìƒí’ˆ ì¬ê³  í™•ì¸
        async function checkAllProducts() {
            addLog('ğŸ” ëª¨ë“  ìƒí’ˆ ì¬ê³  í™•ì¸ ì‹œì‘...');
            
            try {
                const productsRef = ref(database, 'products');
                const snapshot = await get(productsRef);
                
                if (snapshot.exists()) {
                    const products = snapshot.val();
                    const productsDiv = document.getElementById('products');
                    productsDiv.innerHTML = '';
                    
                    Object.keys(products).forEach(barcode => {
                        const product = products[barcode];
                        const productDiv = document.createElement('div');
                        productDiv.className = 'product';
                        productDiv.innerHTML = `
                            <h3>${product.name || 'ì´ë¦„ ì—†ìŒ'}</h3>
                            <p>ë°”ì½”ë“œ: ${barcode}</p>
                            <p>ê°€ê²©: ${product.price || 0}ì›</p>
                            <p class="${product.inStock ? 'in-stock' : 'out-of-stock'}">
                                ì¬ê³ : ${product.stock || 0}ê°œ ${product.inStock ? '(ì¬ê³  ìˆìŒ)' : '(í’ˆì ˆ)'}
                            </p>
                            <p>ì—…ë°ì´íŠ¸: ${product.updatedAt ? new Date(product.updatedAt).toLocaleString() : 'ì—†ìŒ'}</p>
                        `;
                        productsDiv.appendChild(productDiv);
                    });
                    
                    addLog(`âœ… ${Object.keys(products).length}ê°œ ìƒí’ˆ í™•ì¸ ì™„ë£Œ`);
                } else {
                    addLog('âš ï¸ ìƒí’ˆ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');
                }
            } catch (error) {
                addLog('âŒ ìƒí’ˆ ì¡°íšŒ ì‹¤íŒ¨: ' + error.message);
            }
        }

        // ì¬ê³  ì°¨ê° í…ŒìŠ¤íŠ¸
        async function testStockReduction() {
            const barcode = document.getElementById('barcodeInput').value;
            const quantity = parseInt(document.getElementById('quantityInput').value);
            
            if (!barcode) {
                addLog('âŒ ë°”ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }
            
            if (!quantity || quantity <= 0) {
                addLog('âŒ ìˆ˜ëŸ‰ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }
            
            addLog(`ğŸ§ª ì¬ê³  ì°¨ê° í…ŒìŠ¤íŠ¸ ì‹œì‘: ${barcode} - ${quantity}ê°œ`);
            
            try {
                const productRef = ref(database, `products/${barcode}`);
                const productSnapshot = await get(productRef);
                
                if (productSnapshot.exists()) {
                    const productData = productSnapshot.val();
                    const currentStock = productData.stock || 0;
                    const newStock = currentStock - quantity;
                    
                    addLog(`ğŸ“¦ ${productData.name} ì¬ê³  ì •ë³´:`);
                    addLog(`  - í˜„ì¬ ì¬ê³ : ${currentStock}`);
                    addLog(`  - ì°¨ê° ìˆ˜ëŸ‰: ${quantity}`);
                    addLog(`  - ì°¨ê° í›„ ì¬ê³ : ${newStock}`);
                    
                    await update(productRef, {
                        stock: Math.max(0, newStock),
                        inStock: newStock > 0,
                        updatedAt: Date.now()
                    });
                    
                    addLog(`âœ… ì¬ê³  ì—…ë°ì´íŠ¸ ì™„ë£Œ - ìµœì¢… ì¬ê³ : ${Math.max(0, newStock)}`);
                    
                    // ì—…ë°ì´íŠ¸ í›„ ì¬ê³  ë‹¤ì‹œ í™•ì¸
                    setTimeout(() => {
                        checkAllProducts();
                    }, 1000);
                    
                } else {
                    addLog(`âŒ ìƒí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŒ: ${barcode}`);
                }
            } catch (error) {
                addLog('âŒ ì¬ê³  ì°¨ê° ì‹¤íŒ¨: ' + error.message);
            }
        }

        // ì „ì—­ í•¨ìˆ˜ë¡œ ë“±ë¡
        window.checkAllProducts = checkAllProducts;
        window.testStockReduction = testStockReduction;
        window.clearLog = clearLog;
    </script>
</body>
</html>



